<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Refutar Errores - Sistema</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="config.js"></script>
    <script>const TABLE_NAME = 'refutar_errores'; const TABLE_TITLE = 'üîÑ Refutar Errores';</script>
    <script src="table-logic.js"></script>
</head>
<body>
    <div class="table-container">
        <div class="table-header">
            <h2>üîÑ Refutar Errores</h2>
            <div class="table-actions">
                <button class="btn btn-primary" onclick="openCreateModal()">‚ûï Nuevo</button>
                <button class="btn btn-secondary" onclick="loadData()">üîÑ Actualizar</button>
                <button class="btn btn-success" onclick="exportToExcel()">üìä Exportar Excel</button>
                <button class="btn btn-info" onclick="downloadTemplate()">üìÑ Descargar Plantilla</button>
                <button class="btn btn-warning" onclick="openPasteModal()">üìã Pegar Datos CSV</button>
                <button class="btn btn-danger" onclick="deleteAllData()">üóëÔ∏è Eliminar Todo</button>
                <button class="btn btn-dark" onclick="openStatsModal()">üìà Estad√≠sticas</button>
            </div>
        </div>
        <div class="data-table-wrapper">
            <div style="margin-bottom:1rem;">
                <input type="text" id="searchInput" placeholder="üîç Buscar..." style="width: 300px; padding: 0.5rem; border-radius: 0.25rem; border: 1px solid #ccc;" oninput="filterTable()">
            </div>
            <div id="loadingIndicator" class="loading"><div class="spinner"></div><p>Cargando...</p></div>
            <div id="tableContainer"></div>
        </div>
    </div>
    <!-- Modal de estad√≠sticas -->
    <div id="statsModal" class="modal" style="display:none;">
        <div class="modal-content">
            <div class="modal-header"><h3>üìà Estad√≠sticas de Refutaci√≥n</h3></div>
            <div class="modal-body" id="statsContent"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeStatsModal()">Cerrar</button>
            </div>
        </div>
    </div>
    <div id="dataModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3 id="modalTitle">Nuevo Registro</h3></div>
            <form id="dataForm">
                <input type="hidden" id="recordId">
                <div id="formFields"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
                    <button type="submit" class="btn btn-success">Guardar</button>
                </div>
            </form>
        </div>
    </div>
    <script>
                // Variables para datos y filtro
                let allData = [];
                let filteredData = [];

                // Filtro de b√∫squeda
                function filterTable() {
                    const search = document.getElementById('searchInput').value.toLowerCase();
                    filteredData = allData.filter(row => {
                        return Object.values(row).some(val => (val || '').toString().toLowerCase().includes(search));
                    });
                    renderTable(filteredData);
                }

                // Modal de estad√≠sticas
                function openStatsModal() {
                    const total = allData.length;
                    const refutados = allData.filter(row => row.evidencia1 && row.evidencia1.trim() !== '').length;
                    document.getElementById('statsContent').innerHTML = `
                        <p><strong>Total errores cargados:</strong> ${total}</p>
                        <p><strong>Total errores refutados:</strong> ${refutados}</p>
                        <p><strong>Porcentaje refutado:</strong> ${total > 0 ? ((refutados/total)*100).toFixed(2) : '0'}%</p>
                    `;
                    document.getElementById('statsModal').style.display = 'block';
                }
                function closeStatsModal() {
                    document.getElementById('statsModal').style.display = 'none';
                }

                // Renderizar tabla con orden por evidencia1
                function renderTable(data) {
                    // Ordenar primero los que tienen evidencia1
                    data = [...data].sort((a, b) => {
                        const aHas = a.evidencia1 && a.evidencia1.trim() !== '' ? 1 : 0;
                        const bHas = b.evidencia1 && b.evidencia1.trim() !== '' ? 1 : 0;
                        return bHas - aHas;
                    });
                    // Aqu√≠ deber√≠as tener tu l√≥gica para renderizar la tabla en #tableContainer
                    // Si usas table-logic.js, llama la funci√≥n adecuada, si no, genera la tabla aqu√≠
                    // Ejemplo simple:
                    const container = document.getElementById('tableContainer');
                    if (!data.length) {
                        container.innerHTML = '<p>No hay datos para mostrar.</p>';
                        return;
                    }
                    // Definir columnas a mostrar y ordenarlas
                    let cols = Object.keys(data[0]).filter(c => c !== 'id');
                    // Mover 'lector' al inicio si existe
                    if (cols.includes('lector')) {
                        cols = ['lector', ...cols.filter(c => c !== 'lector')];
                    }
                    let html = '<table class="data-table"><thead><tr>' + cols.map(c => `<th>${c.toUpperCase()}</th>`).join('') + '</tr></thead><tbody>';
                    data.forEach(row => {
                        html += '<tr>' + cols.map(c => {
                            if (c === 'evidencia1' || c === 'evidencia2') {
                                const val = row[c] || '';
                                if (val) {
                                    return `<td><a href="${val}" target="_blank" rel="noopener noreferrer">Ver</a></td>`;
                                } else {
                                    return '<td>-</td>';
                                }
                            }
                            return `<td>${row[c] || ''}</td>`;
                        }).join('') + '</tr>';
                    });
                    html += '</tbody></table>';
                    container.innerHTML = html;
                }

        // Modal para mostrar evidencia
        function showEvidenciaModal(col, val) {
            const valor = decodeURIComponent(val);
            let titulo = col === 'evidencia1' ? 'Evidencia 1' : 'Evidencia 2';
            let modalHtml = `<div id="evidenciaModal" class="modal" style="display:block;z-index:2000;">
                <div class="modal-content">
                    <div class="modal-header"><h3>${titulo}</h3></div>
                    <div class="modal-body"><pre style="white-space:pre-wrap;word-break:break-word;">${valor}</pre></div>
                    <div class="modal-footer"><button type="button" class="btn btn-secondary" onclick="closeEvidenciaModal()">Cerrar</button></div>
                </div>
            </div>`;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
        function closeEvidenciaModal() {
            const modal = document.getElementById('evidenciaModal');
            if (modal) document.body.removeChild(modal);
        }
                

                // Sobreescribir loadData para usar allData y renderTable
                async function loadData() {
                    const loadingIndicator = document.getElementById('loadingIndicator');
                    loadingIndicator.style.display = 'block';
                    const { data, error } = await supabase
                        .from(TABLE_NAME)
                        .select('*');
                    loadingIndicator.style.display = 'none';
                    if (error) {
                        alert('Error al cargar los datos: ' + error.message);
                        return;
                    }
                    allData = data || [];
                    filteredData = allData;
                    renderTable(filteredData);
                }
        async function exportToExcel() {
            try {
                // Show loading indicator
                const loadingIndicator = document.getElementById('loadingIndicator');
                loadingIndicator.style.display = 'block';
                
                // Fetch all data from Supabase without limit
                const { data, error } = await supabase
                    .from(TABLE_NAME)
                    .select('*')
                    .order('id', { ascending: false });
                
                if (error) throw error;
                
                if (!data || data.length === 0) {
                    alert('No hay datos para exportar');
                    loadingIndicator.style.display = 'none';
                    return;
                }
                
                // Create workbook and worksheet
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(data);
                
                // Add worksheet to workbook
                XLSX.utils.book_append_sheet(wb, ws, 'Refutar Errores');
                
                // Generate filename with current date
                const now = new Date();
                const dateStr = now.toISOString().slice(0, 10);
                const timeStr = now.toTimeString().slice(0, 5).replace(':', '');
                const filename = `refutar_errores_${dateStr}_${timeStr}.xlsx`;
                
                // Save file
                XLSX.writeFile(wb, filename);
                
                loadingIndicator.style.display = 'none';
                
            } catch (error) {
                console.error('Error al exportar:', error);
                alert('Error al exportar los datos: ' + error.message);
                document.getElementById('loadingIndicator').style.display = 'none';
            }
        }

        async function deleteAllData() {
            // First confirmation
            const firstConfirm = confirm('‚ö†Ô∏è ATENCI√ìN: Esta acci√≥n eliminar√° TODOS los registros de la tabla "Refutar Errores".\n\n¬øEst√°s seguro de que deseas continuar?');
            
            if (!firstConfirm) return;
            
            // Second confirmation with typing requirement
            const confirmText = prompt('Para confirmar esta acci√≥n DESTRUCTIVA, escribe exactamente: "ELIMINAR TODO"\n\n(Esta acci√≥n no se puede deshacer)');
            
            if (confirmText !== 'ELIMINAR TODO') {
                if (confirmText !== null) {
                    alert('Texto de confirmaci√≥n incorrecto. Operaci√≥n cancelada.');
                }
                return;
            }
            
            try {
                // Show loading indicator
                const loadingIndicator = document.getElementById('loadingIndicator');
                loadingIndicator.style.display = 'block';
                
                // Delete all records using a condition that matches all rows
                const { error } = await supabase
                    .from(TABLE_NAME)
                    .delete()
                    .not('id', 'is', null); // This will match all rows since id is never null
                
                if (error) throw error;
                
                // Hide loading indicator
                loadingIndicator.style.display = 'none';
                
                // Show success message
                alert('‚úÖ Todos los registros han sido eliminados exitosamente.');
                
                // Reload the table to show empty state
                loadData();
                
            } catch (error) {
                console.error('Error al eliminar datos:', error);
                let errorMessage = error.message || 'Error desconocido';
                
                // Provide more specific error information
                if (error.message && error.message.includes('Failed to fetch')) {
                    errorMessage += '\n\nPosibles causas:\n‚Ä¢ Problemas de conexi√≥n a Supabase\n‚Ä¢ Permisos insuficientes en la tabla\n‚Ä¢ Pol√≠ticas RLS (Row Level Security) bloqueando la operaci√≥n';
                }
                
                alert('‚ùå Error al eliminar los datos: ' + errorMessage);
                document.getElementById('loadingIndicator').style.display = 'none';
            }
        }

        function downloadTemplate() {
            try {
                // Define the columns for the template
                const templateColumns = [
                    'causa_observacion',
                    'adicional',
                    'direccion',
                    'consumo',
                    'alfa',
                    'ciclo',
                    'error',
                    'lector',
                    'instalacion',
                    'supervisor_zona',
                    'foto',
                    'falta_firma',
                    'observacion',
                    'debia_dejar_constancia',
                    'observacion_constancia'
                ];
                
                // Create an empty row with the column headers
                const templateData = [{}];
                templateColumns.forEach(col => {
                    templateData[0][col] = '';
                });
                
                // Add a few example rows with placeholder data
                const exampleRows = [
                    {
                        causa_observacion: 'Ejemplo: Medidor da√±ado',
                        adicional: 'Informaci√≥n adicional de ejemplo',
                        direccion: 'Calle 123 #45-67',
                        consumo: '150',
                        alfa: 'A1',
                        ciclo: '2024-12',
                        error: 'NO',
                        lector: 'Juan P√©rez',
                        instalacion: '12345678',
                        supervisor_zona: 'Mar√≠a Garc√≠a',
                        foto: 'SI',
                        falta_firma: 'NO',
                        observacion: 'Observaci√≥n de ejemplo',
                        debia_dejar_constancia: 'SI',
                        observacion_constancia: 'Constancia dejada correctamente',
                        error: 'NO'
                    },
                    {
                        causa_observacion: '',
                        adicional: '',
                        direccion: '',
                        consumo: '',
                        alfa: '',
                        ciclo: '',
                        error: '',
                        lector: '',
                        instalacion: '',
                        supervisor_zona: '',
                        foto: '',
                        falta_firma: '',
                        observacion: '',
                        debia_dejar_constancia: '',
                        observacion_constancia: '',
                        error: ''
                    }
                ];
                
                // Combine template with examples
                const finalData = [...exampleRows];
                
                // Create workbook and worksheet
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(finalData);
                
                // Set column widths for better readability
                ws['!cols'] = templateColumns.map(() => ({ width: 20 }));
                
                // Add some styling to the header row
                const headerRow = 1;
                templateColumns.forEach((col, index) => {
                    const cellRef = XLSX.utils.encode_cell({ r: 0, c: index });
                    if (ws[cellRef]) {
                        ws[cellRef].s = {
                            fill: { fgColor: { rgb: "366092" } },
                            font: { color: { rgb: "FFFFFF" }, bold: true }
                        };
                    }
                });
                
                // Add worksheet to workbook
                XLSX.utils.book_append_sheet(wb, ws, 'Plantilla Refutar Errores');
                
                // Generate filename with current date
                const now = new Date();
                const dateStr = now.toISOString().slice(0, 10);
                const filename = `plantilla_refutar_errores_${dateStr}.xlsx`;
                
                // Save file
                XLSX.writeFile(wb, filename);
                
                // Show success message
                alert('‚úÖ Plantilla descargada exitosamente.\n\nInstrucciones:\n‚Ä¢ La primera fila contiene un ejemplo\n‚Ä¢ Elimina la fila de ejemplo antes de importar\n‚Ä¢ Completa los datos en las filas siguientes\n‚Ä¢ Guarda el archivo antes de importar');
                
            } catch (error) {
                console.error('Error al descargar plantilla:', error);
                alert('‚ùå Error al descargar la plantilla: ' + error.message);
            }
        }

        // Variables globales para el modal CSV
        let datosCSVPreview = null;
        let textoCSVActual = '';

        // Funci√≥n para abrir modal de pegar datos CSV
        function openPasteModal() {
            console.log('üìù Abriendo modal de pegar datos CSV...');
            
            // Crear modal din√°micamente
            const modalHTML = `
                <div id="pasteModal" class="modal" style="
                    display: block;
                    position: fixed;
                    z-index: 1000;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    background-color: rgba(0,0,0,0.5);
                ">
                    <div class="modal-content" style="
                        background-color: #fefefe;
                        margin: 2% auto;
                        padding: 1.5rem;
                        border: none;
                        width: 90%;
                        max-width: 900px;
                        border-radius: 0.5rem;
                        max-height: 90vh;
                        overflow-y: auto;
                    ">
                        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; border-bottom: 1px solid #dee2e6; padding-bottom: 1rem;">
                            <h3 style="margin: 0; color: #495057;">üìã Pegar Datos CSV - Refutar Errores</h3>
                            <button onclick="closePasteModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6c757d;">&times;</button>
                        </div>
                        
                        <div class="modal-body">
                            <!-- Instrucciones -->
                            <div style="background: #e7f3ff; border: 1px solid #b3d7ff; border-radius: 0.25rem; padding: 1rem; margin-bottom: 1.5rem;">
                                <h5 style="margin: 0 0 0.5rem 0; color: #0056b3;">üí° Instrucciones:</h5>
                                <ul style="margin: 0; padding-left: 1.2rem; color: #0056b3;">
                                    <li>Copia los datos CSV desde Excel, Google Sheets o cualquier aplicaci√≥n</li>
                                    <li>Pega directamente en el campo de abajo (Ctrl+V)</li>
                                    <li>La primera fila debe contener los nombres de las columnas</li>
                                    <li>Columnas requeridas: <strong>causa_observacion, direccion, instalacion</strong></li>
                                    <li>Columnas disponibles: <em>adicional, consumo, alfa, ciclo, lector, supervisor_zona, foto, falta_firma, observacion, debia_dejar_constancia, observacion_constancia, error</em></li>
                                </ul>
                            </div>
                            
                            <!-- √Årea de texto principal -->
                            <div style="margin-bottom: 1rem;">
                                <label for="csvTextArea" style="display: block; margin-bottom: 0.5rem; font-weight: bold; color: #495057;">
                                    üìã Pegar datos CSV aqu√≠:
                                </label>
                                <textarea 
                                    id="csvTextArea" 
                                    placeholder="Pega aqu√≠ tus datos CSV...&#10;&#10;Ejemplo:&#10;causa_observacion,direccion,instalacion,adicional,error&#10;Medidor da√±ado,Calle 123 #45-67,12345678,Requiere cambio,NO&#10;Lectura err√≥nea,Carrera 45 #12-34,87654321,Revisar medidor,SI"
                                    style="
                                        width: 100%; 
                                        height: 300px; 
                                        padding: 0.75rem; 
                                        border: 2px dashed #ced4da; 
                                        border-radius: 0.25rem;
                                        font-family: 'Courier New', monospace;
                                        font-size: 0.875rem;
                                        resize: vertical;
                                        background: #f8f9fa;
                                    "
                                ></textarea>
                            </div>
                            
                            <!-- Botones de acci√≥n -->
                            <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                                <button onclick="processCSVText()" id="procesarBtn" style="
                                    background: #28a745; 
                                    color: white; 
                                    border: none; 
                                    padding: 0.5rem 1rem; 
                                    border-radius: 0.25rem; 
                                    cursor: pointer;
                                    font-weight: bold;
                                ">üîÑ Procesar Datos</button>
                                
                                <button onclick="clearCSVText()" style="
                                    background: #6c757d; 
                                    color: white; 
                                    border: none; 
                                    padding: 0.5rem 1rem; 
                                    border-radius: 0.25rem; 
                                    cursor: pointer;
                                ">üóëÔ∏è Limpiar</button>
                                
                                <button onclick="showCSVExample()" style="
                                    background: #17a2b8; 
                                    color: white; 
                                    border: none; 
                                    padding: 0.5rem 1rem; 
                                    border-radius: 0.25rem; 
                                    cursor: pointer;
                                ">üìã Ver Ejemplo</button>
                            </div>
                            
                            <!-- √Årea de preview -->
                            <div id="csvPreviewArea" style="display: none;">
                                <hr style="margin: 1.5rem 0;">
                                <h5 style="color: #495057; margin-bottom: 1rem;">üëÄ Vista Previa:</h5>
                                <div id="csvPreviewContent"></div>
                                
                                <!-- Botones de carga -->
                                <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid #dee2e6;">
                                    <button onclick="confirmCSVUpload()" id="cargarBtn" disabled style="
                                        background: #007bff; 
                                        color: white; 
                                        border: none; 
                                        padding: 0.75rem 1.5rem; 
                                        border-radius: 0.25rem; 
                                        cursor: pointer;
                                        font-weight: bold;
                                        margin-right: 0.5rem;
                                    ">‚¨ÜÔ∏è Cargar a la Base de Datos</button>
                                    
                                    <button onclick="closePasteModal()" style="
                                        background: #6c757d; 
                                        color: white; 
                                        border: none; 
                                        padding: 0.75rem 1.5rem; 
                                        border-radius: 0.25rem; 
                                        cursor: pointer;
                                    ">‚ùå Cancelar</button>
                                </div>
                            </div>
                            
                            <!-- √Årea de progreso -->
                            <div id="csvProgressArea" style="display: none; margin-top: 1.5rem; padding: 1rem; background: #f8f9fa; border-radius: 0.25rem;">
                                <h6 style="margin: 0 0 1rem 0; color: #495057;">‚è≥ Cargando datos...</h6>
                                <div style="background: #e9ecef; border-radius: 0.25rem; overflow: hidden; margin-bottom: 0.5rem;">
                                    <div id="csvProgressBar" style="background: #007bff; height: 1.5rem; width: 0%; transition: width 0.3s ease; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;"></div>
                                </div>
                                <div id="csvProgressText" style="font-size: 0.875rem; color: #6c757d; text-align: center;">Iniciando...</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Agregar modal al DOM
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Enfocar el textarea
            setTimeout(() => {
                document.getElementById('csvTextArea').focus();
            }, 100);
        }

        // Funci√≥n para cerrar modal de pegar datos
        function closePasteModal() {
            const modal = document.getElementById('pasteModal');
            if (modal) {
                document.body.removeChild(modal);
            }
            textoCSVActual = '';
            datosCSVPreview = null;
        }

        // Funci√≥n para mostrar ejemplo en el textarea
        function showCSVExample() {
            const ejemplo = `causa_observacion,direccion,instalacion,adicional,consumo,alfa,ciclo,error,lector,supervisor_zona,foto,falta_firma,observacion,debia_dejar_constancia,observacion_constancia
Medidor con falla en display,Calle 123 #45-67,12345678,Requiere cambio de medidor,150,A1,2024-12,NO,Juan P√©rez,Mar√≠a Garc√≠a,SI,NO,Medidor presenta da√±os visibles,SI,Se dej√≥ constancia al usuario
Lectura err√≥nea por obst√°culo,Carrera 45 #12-34,87654321,Vegetaci√≥n obstruye medidor,200,B2,2024-12,SI,Carlos L√≥pez,Ana Rodr√≠guez,SI,NO,Ramas tapan el display,NO,Usuario no se encontraba
Error en registro anterior,Avenida 80 #23-45,11223344,Revisar historial de lecturas,175,C3,2024-12,NO,Pedro Mart√≠nez,Luis Hern√°ndez,NO,SI,Inconsistencia en lecturas previas,SI,Firm√≥ el supervisor`;
            
            document.getElementById('csvTextArea').value = ejemplo;
            
            alert(`üìã Ejemplo cargado en el campo de texto!

üí° Este ejemplo incluye:
‚Ä¢ 3 registros de muestra para refutar errores
‚Ä¢ Todas las columnas principales del sistema
‚Ä¢ Formato CSV est√°ndar separado por comas
‚Ä¢ Datos realistas para el contexto

‚úÖ Puedes modificar este ejemplo o reemplazarlo con tus propios datos.`);
        }

        // Funci√≥n para limpiar el textarea
        function clearCSVText() {
            document.getElementById('csvTextArea').value = '';
            document.getElementById('csvPreviewArea').style.display = 'none';
            document.getElementById('cargarBtn').disabled = true;
            textoCSVActual = '';
            datosCSVPreview = null;
        }

        // Funci√≥n para procesar el texto CSV pegado
        function processCSVText() {
            const textarea = document.getElementById('csvTextArea');
            const texto = textarea.value.trim();
            
            if (!texto) {
                alert('‚ö†Ô∏è Por favor pega los datos CSV en el campo de texto.');
                return;
            }
            
            console.log('üîÑ Procesando texto CSV pegado...');
            
            try {
                // Parsear el texto CSV
                const { datos, errores } = parseCSV(texto);
                
                // Guardar datos procesados
                textoCSVActual = texto;
                datosCSVPreview = { datos, errores };
                
                // Mostrar preview
                showCSVPreview(datos, errores);
                
                // Habilitar bot√≥n de carga si hay datos v√°lidos
                document.getElementById('cargarBtn').disabled = datos.length === 0;
                
            } catch (error) {
                console.error('‚ùå Error procesando texto CSV:', error);
                alert('‚ùå Error al procesar los datos: ' + error.message + '\n\nüí° Verifica que:\n‚Ä¢ La primera fila contenga los nombres de columnas\n‚Ä¢ Los datos est√©n separados por comas\n‚Ä¢ Las columnas requeridas est√©n presentes');
            }
        }

        // Funci√≥n para parsear CSV
        function parseCSV(texto) {
            console.log('üîç Parseando contenido CSV...');
            
            const lineas = texto.split('\n').map(linea => linea.trim()).filter(linea => linea.length > 0);
            
            if (lineas.length < 2) {
                throw new Error('El archivo debe contener al menos una fila de encabezados y una de datos');
            }
            
            // Detectar el delimitador autom√°ticamente
            const primeraLinea = lineas[0];
            let delimitador = ',';
            
            const numComas = (primeraLinea.match(/,/g) || []).length;
            const numTabs = (primeraLinea.match(/\t/g) || []).length;
            
            if (numTabs > numComas) {
                delimitador = '\t';
                console.log('‚úÖ Delimitador detectado: TABULACI√ìN (datos de Excel)');
            } else {
                console.log('‚úÖ Delimitador detectado: COMA (CSV est√°ndar)');
            }
            
            // Parsear encabezados
            const encabezados = parseCSVRow(lineas[0], delimitador);
            console.log('üìù Encabezados detectados:', encabezados);
            
            // Columnas conocidas para refutar_errores
            const columnasConocidas = [
                'causa_observacion', 'adicional', 'direccion', 'consumo', 'alfa', 
                'ciclo', 'error', 'lector', 'instalacion', 'supervisor_zona', 'foto', 
                'falta_firma', 'observacion', 'debia_dejar_constancia', 'observacion_constancia'
            ];
            
            // Validar columnas esenciales (m√°s flexible - solo requiere una de las principales)
            const columnasEsenciales = ['direccion', 'instalacion'];
            const columnasEsencialesNoEncontradas = columnasEsenciales.filter(col => !encabezados.includes(col));
            if (columnasEsencialesNoEncontradas.length > 1) {
                throw new Error(`Faltan columnas esenciales. Se requiere al menos: ${columnasEsenciales.join(' y ')}`);
            }
            
            // Verificar columnas no reconocidas
            const columnasNoReconocidas = encabezados.filter(col => !columnasConocidas.includes(col));
            if (columnasNoReconocidas.length > 0) {
                console.warn('‚ö†Ô∏è Columnas no reconocidas (ser√°n ignoradas):', columnasNoReconocidas);
            }
            
            const datos = [];
            const errores = [];
            
            // Procesar filas de datos
            for (let i = 1; i < lineas.length; i++) {
                try {
                    const valores = parseCSVRow(lineas[i], delimitador);
                    
                    // Ser m√°s flexible con el n√∫mero de columnas - rellenar con vac√≠os si faltan
                    while (valores.length < encabezados.length) {
                        valores.push('');
                    }
                    
                    // Si hay m√°s valores que encabezados, truncar
                    if (valores.length > encabezados.length) {
                        valores = valores.slice(0, encabezados.length);
                        errores.push(`Fila ${i + 1}: Se encontraron columnas adicionales que fueron ignoradas`);
                    }
                    
                    const registro = {};
                    encabezados.forEach((encabezado, index) => {
                        if (columnasConocidas.includes(encabezado)) {
                            // Manejar valores null, undefined o vac√≠os m√°s graciosamente
                            let valor = valores[index];
                            if (valor === undefined || valor === null) {
                                valor = '';
                            } else if (typeof valor === 'string') {
                                valor = valor.trim();
                                // Convertir "null", "NULL", "undefined" en texto a cadena vac√≠a
                                if (valor.toLowerCase() === 'null' || valor.toLowerCase() === 'undefined') {
                                    valor = '';
                                }
                            }
                            registro[encabezado] = valor;
                        }
                    });
                    
                    // Validaciones m√°s flexibles - solo campos realmente cr√≠ticos
                    let tieneContenidoValido = false;
                    
                    // Verificar que al menos tenga direcci√≥n o instalaci√≥n con contenido
                    if (registro.direccion && registro.direccion.trim() !== '') {
                        tieneContenidoValido = true;
                    }
                    if (registro.instalacion && registro.instalacion.trim() !== '') {
                        tieneContenidoValido = true;
                    }
                    
                    if (!tieneContenidoValido) {
                        errores.push(`Fila ${i + 1}: Se requiere al menos 'direccion' o 'instalacion' con contenido`);
                        continue;
                    }
                    
                    datos.push(registro);
                    
                } catch (error) {
                    errores.push(`Fila ${i + 1}: ${error.message}`);
                }
            }
            
            console.log(`‚úÖ Procesados ${datos.length} registros v√°lidos, ${errores.length} errores`);
            return { datos, errores };
        }

        // Funci√≥n para parsear una fila CSV (mejorada para manejar celdas vac√≠as)
        function parseCSVRow(fila, delimitador = ',') {
            const resultado = [];
            let valorActual = '';
            let dentroDeComillas = false;
            let i = 0;
            
            while (i < fila.length) {
                const char = fila[i];
                
                if (char === '"' && !dentroDeComillas) {
                    dentroDeComillas = true;
                } else if (char === '"' && dentroDeComillas) {
                    if (i + 1 < fila.length && fila[i + 1] === '"') {
                        valorActual += '"';
                        i++;
                    } else {
                        dentroDeComillas = false;
                    }
                } else if (char === delimitador && !dentroDeComillas) {
                    // Limpiar valor antes de agregarlo
                    let valorLimpio = valorActual.trim();
                    // Manejar valores especiales
                    if (valorLimpio === 'NULL' || valorLimpio === 'null' || valorLimpio === '#N/A' || valorLimpio === '') {
                        valorLimpio = '';
                    }
                    resultado.push(valorLimpio);
                    valorActual = '';
                } else {
                    valorActual += char;
                }
                
                i++;
            }
            
            // Agregar el √∫ltimo valor (tambi√©n limpiarlo)
            let valorLimpio = valorActual.trim();
            if (valorLimpio === 'NULL' || valorLimpio === 'null' || valorLimpio === '#N/A') {
                valorLimpio = '';
            }
            resultado.push(valorLimpio);
            
            return resultado;
        }

        // Funci√≥n para mostrar preview de los datos procesados
        function showCSVPreview(datos, errores) {
            const previewArea = document.getElementById('csvPreviewArea');
            const previewContent = document.getElementById('csvPreviewContent');
            
            let html = '';
            
            // Mostrar errores si existen
            if (errores.length > 0) {
                html += `
                    <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 0.25rem; padding: 0.75rem; margin-bottom: 1rem;">
                        <h6 style="color: #856404; margin: 0 0 0.5rem 0;">‚ö†Ô∏è Advertencias/Errores (${errores.length}):</h6>
                        <div style="max-height: 120px; overflow-y: auto; font-size: 0.875rem;">
                            ${errores.slice(0, 15).map(error => `<div style="color: #856404;">‚Ä¢ ${error}</div>`).join('')}
                            ${errores.length > 15 ? `<div style="color: #856404; font-style: italic;">...y ${errores.length - 15} m√°s</div>` : ''}
                        </div>
                    </div>
                `;
            }
            
            // Mostrar resumen y datos
            if (datos.length > 0) {
                const columnas = Object.keys(datos[0]);
                const muestra = datos.slice(0, 5);
                
                html += `
                    <div style="background: #d1edff; border: 1px solid #7cc7ff; border-radius: 0.25rem; padding: 0.75rem; margin-bottom: 1rem;">
                        <h6 style="color: #004085; margin: 0 0 0.5rem 0;">‚úÖ Datos procesados correctamente</h6>
                        <div style="color: #004085; font-size: 0.875rem;">
                            <strong>üìä Registros v√°lidos:</strong> ${datos.length} | 
                            <strong>üìã Columnas detectadas:</strong> ${columnas.length}
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <strong>Columnas detectadas:</strong><br>
                        <div style="display: flex; flex-wrap: wrap; gap: 0.25rem; margin-top: 0.5rem;">
                            ${columnas.map(col => {
                                const esEsencial = ['causa_observacion', 'direccion', 'instalacion'].includes(col);
                                const color = esEsencial ? '#28a745' : '#6c757d';
                                const icon = esEsencial ? '‚úÖ' : 'üìã';
                                return `<span style="background: ${color}; color: white; padding: 0.2rem 0.5rem; border-radius: 0.2rem; font-size: 0.8rem;">${icon} ${col.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</span>`;
                            }).join('')}
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <strong>Vista previa (primeros ${muestra.length} registros):</strong>
                    </div>
                    
                    <div style="overflow-x: auto; max-height: 300px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 0.25rem;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.8rem;">
                            <thead style="position: sticky; top: 0; background: #f8f9fa;">
                                <tr>
                                    ${columnas.map(col => `<th style="padding: 0.5rem; border-bottom: 2px solid #dee2e6; text-align: left; font-weight: bold; white-space: nowrap;">${col.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</th>`).join('')}
                                </tr>
                            </thead>
                            <tbody>
                                ${muestra.map((fila, index) => `
                                    <tr style="background: ${index % 2 === 0 ? '#ffffff' : '#f8f9fa'};">
                                        ${columnas.map(col => {
                                            let valor = fila[col] || '';
                                            if (valor.length > 40) valor = valor.substring(0, 37) + '...';
                                            return `<td style="padding: 0.5rem; border-bottom: 1px solid #dee2e6; white-space: nowrap;">${valor || '<span style="color: #6c757d;">-</span>'}</td>`;
                                        }).join('')}
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    ${datos.length > 5 ? `<div style="margin-top: 0.5rem; font-size: 0.875rem; color: #6c757d; text-align: center; font-style: italic;">...y ${datos.length - 5} registros m√°s</div>` : ''}
                `;
            } else {
                html += `
                    <div style="background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 0.25rem; padding: 0.75rem;">
                        <h6 style="color: #721c24; margin: 0;">‚ùå No se encontraron datos v√°lidos</h6>
                        <p style="color: #721c24; margin: 0.5rem 0 0 0; font-size: 0.875rem;">Verifica el formato de los datos y vuelve a intentar.</p>
                    </div>
                `;
            }
            
            previewContent.innerHTML = html;
            previewArea.style.display = 'block';
        }

        // Funci√≥n para confirmar y cargar los datos
        async function confirmCSVUpload() {
            if (!datosCSVPreview || !datosCSVPreview.datos || datosCSVPreview.datos.length === 0) {
                alert('‚ùå No hay datos v√°lidos para cargar.');
                return;
            }
            
            const { datos, errores } = datosCSVPreview;
            
            let mensaje = `üìä Se van a cargar ${datos.length} registros a la base de datos.`;
            if (errores.length > 0) {
                mensaje += `\n‚ö†Ô∏è Se encontraron ${errores.length} errores/advertencias que fueron omitidos.`;
            }
            mensaje += '\n\n¬øConfirmas la carga?';
            
            if (!confirm(mensaje)) {
                return;
            }
            
            try {
                // Mostrar √°rea de progreso
                document.getElementById('csvProgressArea').style.display = 'block';
                document.getElementById('cargarBtn').disabled = true;
                document.getElementById('procesarBtn').disabled = true;
                
                // Cargar datos con progreso
                await uploadCSVData(datos);
                
                // Cerrar modal y recargar tabla
                closePasteModal();
                loadData();
                
                alert(`‚úÖ ¬°Carga completada exitosamente!
                
üìä ${datos.length} registros cargados a la base de datos.
üîÑ La tabla se ha actualizado autom√°ticamente.`);
                
            } catch (error) {
                console.error('‚ùå Error en carga:', error);
                alert('‚ùå Error durante la carga: ' + error.message);
            } finally {
                document.getElementById('cargarBtn').disabled = false;
                document.getElementById('procesarBtn').disabled = false;
                document.getElementById('csvProgressArea').style.display = 'none';
            }
        }

        // Funci√≥n para cargar datos con barra de progreso
        async function uploadCSVData(datos) {
            console.log(`üìÅ Iniciando carga de ${datos.length} registros desde texto CSV...`);
            
            const tamanoLote = 50;
            const totalLotes = Math.ceil(datos.length / tamanoLote);
            let procesados = 0;
            let exitosos = 0;
            let fallidos = 0;
            
            const progressBar = document.getElementById('csvProgressBar');
            const progressText = document.getElementById('csvProgressText');
            
            for (let i = 0; i < datos.length; i += tamanoLote) {
                const lote = datos.slice(i, i + tamanoLote);
                const loteActual = Math.floor(i / tamanoLote) + 1;
                
                try {
                    // Actualizar progreso
                    const porcentaje = Math.round((procesados / datos.length) * 100);
                    progressBar.style.width = porcentaje + '%';
                    progressBar.textContent = porcentaje + '%';
                    progressText.textContent = `Procesando lote ${loteActual} de ${totalLotes} - ${procesados}/${datos.length} registros`;
                    
                    console.log(`üîÑ Procesando lote ${loteActual}/${totalLotes}`);
                    
                    // Insertar lote en Supabase
                    const { data, error } = await supabase
                        .from(TABLE_NAME)
                        .insert(lote);
                    
                    if (error) {
                        console.error('‚ùå Error insertando lote:', error);
                        fallidos += lote.length;
                    } else {
                        exitosos += lote.length;
                    }
                    
                } catch (error) {
                    console.error('‚ùå Error procesando lote:', error);
                    fallidos += lote.length;
                }
                
                procesados += lote.length;
                
                // Pausa peque√±a para no sobrecargar
                await new Promise(resolve => setTimeout(resolve, 200));
            }
            
            // Progreso final
            progressBar.style.width = '100%';
            progressBar.textContent = '‚úÖ 100%';
            progressText.textContent = `Completado: ${exitosos} exitosos, ${fallidos} fallidos de ${procesados} total`;
            
            console.log(`‚úÖ Carga desde texto completada: ${exitosos} exitosos, ${fallidos} fallidos`);
            
            return { procesados, exitosos, fallidos };
        }
    </script>
</body>
</html>
